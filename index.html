<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="appTitle">Solana Ã‡arkÄ±felek - ÅžansÄ±nÄ± Dene</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Solana Web3.js -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <!-- Confetti Efekti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Tone.js (Ses Efektleri) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #0c1221;
            background-image: radial-gradient(circle at center, #1b2742 0%, #0c1221 100%);
            color: white;
            overflow-x: hidden;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.1); 
        }

        .wheel-container {
            position: relative;
            width: 350px;
            height: 350px;
            margin: 0 auto;
            border-radius: 50%;
            border: 12px solid #a855f7;
            box-shadow: 0 0 70px rgba(168, 85, 247, 0.8), inset 0 0 25px rgba(0, 0, 0, 0.9);
            overflow: hidden;
            transition: transform 0.1s;
        }

        @media (min-width: 768px) {
            .wheel-container {
                width: 500px;
                height: 500px;
                border-width: 18px;
            }
        }

        .stopper {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 60px;
            background: #14F195;
            box-shadow: 0 5px 20px rgba(20, 241, 149, 1), 0 0 10px #14F195;
            clip-path: polygon(100% 0, 50% 100%, 0 0);
            z-index: 20;
        }
        
        .center-pivot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle at top left, #ffffff 30%, #a855f7 50%, #4c1d95 100%);
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.8), inset 0 0 10px rgba(0, 0, 0, 0.8);
            z-index: 25;
        }

        canvas {
            width: 100%;
            height: 100%;
            transition: transform 5s cubic-bezier(0.17, 0.67, 0.12, 0.99); 
        }

        .spin-btn {
            background: linear-gradient(to right, #9945FF, #14F195);
            box-shadow: 0 8px 0 #5b21b6, 0 20px 30px rgba(0,0,0,0.6);
            transition: all 0.1s;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
        }
        .spin-btn:active {
            transform: translateY(8px);
            box-shadow: 0 0 0 #5b21b6, 0 0 0 rgba(0,0,0,0.4);
        }
        .spin-btn:disabled {
            background: #4b5563;
            filter: grayscale(100%);
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: 0 6px 0 #374151, 0 0 0 rgba(0,0,0,0.4);
        }

        /* UI Elements */
        #balanceContainer {
            background-color: rgba(30, 41, 59, 0.7);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #334155;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- CÃ¼zdan Bakiyesi -->
    <div id="balanceContainer" class="absolute top-4 left-4 z-50 text-right">
        <p class="text-sm font-semibold text-gray-300">Bakiye:</p>
        <p class="text-xl font-bold text-green-300" id="walletBalance">-- SOL</p>
    </div>

    <!-- CÃ¼zdan BaÄŸla Butonu -->
    <div class="absolute top-4 right-4 z-50">
        <button id="connectWalletBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-full transition shadow-lg border border-purple-500 flex items-center gap-2">
            <svg id="walletIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6">
                <path d="M19.34 4.8C18.42 3.86 17.18 3.29 15.82 3.29H7.13C4.24 3.29 1.9 5.63 1.9 8.52V15.48C1.9 18.37 4.24 20.71 7.13 20.71H15.82C17.18 20.71 18.42 20.14 19.34 19.2C20.26 18.26 20.83 16.98 20.83 15.58V8.42C20.83 7.02 20.26 5.74 19.34 4.8ZM14.07 15.34C13.25 15.34 12.58 14.67 12.58 13.85C12.58 13.03 13.25 12.36 14.07 12.36C14.89 12.36 15.56 13.03 15.56 13.85C15.56 14.67 14.89 15.34 14.07 15.34ZM17.93 11.48C17.11 11.48 16.44 10.81 16.44 9.99C16.44 9.17 17.11 8.5 17.93 8.5C18.75 8.5 19.42 9.17 19.42 9.99C19.42 10.81 18.75 11.48 17.93 11.48Z" fill="white"/>
            </svg>
            <span id="walletAddress">CÃ¼zdan BaÄŸla</span>
        </button>
    </div>

    <!-- BaÅŸlÄ±k -->
    <div class="text-center mb-8 relative z-10 mt-12 md:mt-0">
        <h1 id="mainTitle" class="text-4xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-green-300 to-purple-500 uppercase tracking-wider drop-shadow-sm">
            ÅžansÄ±nÄ± Dene
        </h1>
        <p id="subTitle" class="text-purple-200 mt-2 font-medium">0.05 SOL Ã–de, Ã‡arkÄ± Ã‡evir!</p>
        <p class="text-xs text-yellow-300 mt-2 font-semibold">NOT: TÃ¼m Ã¶dÃ¼ller SOL (Solana) olarak Ã¶denir.</p>
    </div>

    <!-- Ã‡ark AlanÄ± -->
    <div class="relative mb-10">
        <div class="stopper"></div>
        <div class="wheel-container bg-gray-800">
            <canvas id="wheelCanvas" width="500" height="500"></canvas>
            <div class="center-pivot"></div>
        </div>
    </div>

    <!-- Durum MesajÄ± -->
    <div id="statusMessage" class="h-6 text-green-400 font-bold text-center mb-4 transition-all duration-300"></div>

    <!-- Ã‡evirme Butonu -->
    <button id="spinBtn" class="spin-btn px-12 py-4 rounded-full text-xl md:text-2xl font-black uppercase tracking-widest outline-none opacity-50 cursor-not-allowed" disabled>
        Ã–nce CÃ¼zdanÄ± BaÄŸla
    </button>

    <!-- SonuÃ§ ModalÄ± -->
    <div id="resultModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-gray-900 border border-purple-500 p-8 rounded-3xl text-center max-w-sm mx-4 shadow-2xl transform scale-90 transition-transform duration-300" id="resultModalContent">
            <div id="modalIcon" class="text-6xl mb-4">ðŸŽ‰</div>
            <h2 id="modalTitle" class="text-3xl font-bold text-white mb-2">BaÅŸlÄ±k</h2>
            <p id="modalMessage" class="text-xl text-yellow-400 font-bold mb-6">Mesaj</p>
            <button onclick="closeModal('resultModal')" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-xl transition">Tekrar Dene</button>
        </div>
    </div>
    
    <!-- CÃ¼zdan SeÃ§im ModalÄ± -->
    <div id="walletSelectModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-gray-800 border border-green-500 p-8 rounded-3xl text-center max-w-sm mx-4 shadow-2xl transform scale-90 transition-transform duration-300" id="walletModalContent">
            <h2 class="text-2xl font-bold text-white mb-6">CÃ¼zdan SeÃ§</h2>
            <p class="text-gray-300 mb-6">BaÄŸlanmak istediÄŸin cÃ¼zdanÄ± seÃ§.</p>
            
            <button onclick="selectWalletProvider('backpack')" id="selectBackpackBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl transition mb-4 flex items-center justify-center gap-3">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c9/Backpack_Logo.png/640px-Backpack_Logo.png" class="w-6 h-6 rounded-full bg-white p-0.5" alt="Backpack">
                Backpack ile BaÄŸlan
            </button>
            
            <button onclick="selectWalletProvider('phantom')" id="selectPhantomBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-xl transition flex items-center justify-center gap-3">
                <img src="https://cryptologos.cc/logos/phantom-phantom-logo.png" class="w-6 h-6 rounded-full bg-white p-0.5" alt="Phantom">
                Phantom ile BaÄŸlan
            </button>
            
            <button onclick="closeModal('walletSelectModal')" class="mt-4 text-gray-400 hover:text-white transition text-sm">Ä°ptal</button>
        </div>
    </div>

    <script>
        // === YAPILANDIRMA ===
        const translations = {
            tr: {
                connect: "CÃ¼zdan BaÄŸla", 
                disconnect: "Ã‡Ä±kÄ±ÅŸ Yap",
                spinBtnInit: "Ã–nce CÃ¼zdanÄ± BaÄŸla", 
                spinBtnActive: "0.05 SOL Ã–DE VE Ã‡EVÄ°R",
                spinBtnWaiting: "Ä°ÅŸlem OnaylanÄ±yor...", 
                statusConnected: "CÃ¼zdan baÄŸlandÄ±!",
                statusConnectingError: "BaÄŸlantÄ± reddedildi veya hata oluÅŸtu.",
                statusNoWallet: "CÃ¼zdan bulunamadÄ±! LÃ¼tfen Phantom veya Backpack yÃ¼kleyin.",
                statusPaymentConfirm: "LÃ¼tfen cÃ¼zdanÄ±nÄ±zdan iÅŸleme ONAY verin...",
                statusPaymentSending: "Ä°ÅŸlem gÃ¶nderildi, aÄŸ onayÄ± bekleniyor...",
                statusPaymentSuccess: "Ã–deme OnaylandÄ±! Ã‡ark dÃ¶nÃ¼yor...",
                statusPaymentRejected: "Ä°ÅŸlem kullanÄ±cÄ± tarafÄ±ndan reddedildi.",
                statusPaymentInsufficient: "Yetersiz SOL bakiyesi.",
                statusPaymentError: "Hata:", 
                statusDisconnected: "BaÄŸlantÄ± kesildi.",
                modalTitle_win: "Tebrikler!", 
                modalTitle_loss: "Bir Dahaki Sefere!",
                modalTitle_huge_loss: "Eyvah!",
                modalMessage_win_btc: "1 BTC KazandÄ±n! Ä°nanÄ±lmaz!",
                modalMessage_near_miss: "Ã‡ok az farkla kaÃ§Ä±rdÄ±n! Tekrar dene.",
                modalMessage_huge_loss: "BÃœYÃœK KAYIP geldi!",
            }
        };
        
        // --- AYARLAR ---
        // Buraya paranÄ±n gideceÄŸi kendi cÃ¼zdan adresinizi yazÄ±n
        const TREASURY_WALLET = "DAwS12Yo6sF5isULcCQ24rhU67J7vHjRHsH5TjfYerFE"; 
        const SOL_AMOUNT = 0.05;
        const RPC_URL = 'https://rpc.ankr.com/solana'; // GÃ¼venilir Public RPC

        // === BAÅžLANGIÃ‡ ===
        window.addEventListener('DOMContentLoaded', () => {
            
            let connection = null;
            let provider = null;
            let userPublicKey = null;
            let isSpinning = false; 
            let isProcessing = false; 

            // DOM ElemanlarÄ±
            const connectWalletBtn = document.getElementById('connectWalletBtn');
            const walletAddressSpan = document.getElementById('walletAddress');
            const statusMsg = document.getElementById('statusMessage');
            const spinBtn = document.getElementById('spinBtn');
            const walletBalanceElement = document.getElementById('walletBalance');

            // --- YARDIMCI FONKSÄ°YONLAR ---
            const getTranslation = (key) => translations.tr[key] || key;

            // CÃ¼zdan SaÄŸlayÄ±cÄ±larÄ±nÄ± Bulma
            const getAvailableProviders = () => {
                const providers = [];
                // Backpack kontrolÃ¼
                if (window.backpack) {
                    providers.push({ id: 'backpack', name: 'Backpack', provider: window.backpack });
                }
                // Phantom kontrolÃ¼
                if (window.solana && window.solana.isPhantom) {
                    providers.push({ id: 'phantom', name: 'Phantom', provider: window.solana });
                }
                return providers;
            };

            const updateUI = (connected) => {
                if (connected && userPublicKey) {
                    const shortKey = userPublicKey.slice(0, 4) + '...' + userPublicKey.slice(-4);
                    walletAddressSpan.innerText = shortKey + " (Ã‡Ä±kÄ±ÅŸ)";
                    spinBtn.innerText = getTranslation('spinBtnActive');
                    spinBtn.disabled = false;
                    spinBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    spinBtn.classList.add('cursor-pointer');
                    connectWalletBtn.classList.replace('bg-purple-600', 'bg-red-600'); // Ã‡Ä±kÄ±ÅŸ iÃ§in kÄ±rmÄ±zÄ±ya dÃ¶n
                    statusMsg.innerText = getTranslation('statusConnected');
                } else {
                    walletAddressSpan.innerText = getTranslation('connect');
                    spinBtn.innerText = getTranslation('spinBtnInit');
                    spinBtn.disabled = true;
                    spinBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    spinBtn.classList.remove('cursor-pointer');
                    connectWalletBtn.classList.replace('bg-red-600', 'bg-purple-600');
                    connectWalletBtn.classList.replace('bg-green-600', 'bg-purple-600');
                    walletBalanceElement.innerText = '-- SOL';
                    statusMsg.innerText = "";
                }
            };

            // --- CÃœZDAN MANTIÄžI ---
            window.selectWalletProvider = async (id) => {
                window.closeModal('walletSelectModal');
                let selectedProvider = null;

                if (id === 'backpack' && window.backpack) {
                    selectedProvider = window.backpack;
                } else if (id === 'phantom' && window.solana) {
                    selectedProvider = window.solana;
                }

                if (selectedProvider) await connectToProvider(selectedProvider);
            };

            async function connectToProvider(selectedProvider) {
                try {
                    provider = selectedProvider;
                    // Phantom ve Backpack genelde { onlyIfTrusted: false } ile tetiklenir
                    const response = await provider.connect();
                    
                    // Public Key alma (BazÄ± cÃ¼zdanlar response.publicKey dÃ¶ner, bazÄ±larÄ± direkt provider.publicKey)
                    if (response && response.publicKey) {
                        userPublicKey = response.publicKey.toString();
                    } else if (provider.publicKey) {
                        userPublicKey = provider.publicKey.toString();
                    }
                    
                    // RPC BaÄŸlantÄ±sÄ±
                    connection = new solanaWeb3.Connection(RPC_URL, 'confirmed');
                    
                    // Bakiye KontrolÃ¼
                    await fetchBalance();
                    updateUI(true);

                    // BaÄŸlantÄ± koparsa dinle
                    provider.on('disconnect', () => disconnectWallet());
                    // Hesap deÄŸiÅŸirse dinle
                    provider.on('accountChanged', (publicKey) => {
                        if (publicKey) {
                            userPublicKey = publicKey.toString();
                            fetchBalance();
                        } else {
                            disconnectWallet(); // Key yoksa Ã§Ä±kÄ±ÅŸ yap
                        }
                    });

                } catch (err) {
                    console.error("BaÄŸlantÄ± HatasÄ±:", err);
                    statusMsg.innerText = getTranslation('statusConnectingError');
                }
            }

            async function disconnectWallet() {
                if (provider) {
                    try { await provider.disconnect(); } catch(e){}
                }
                provider = null;
                userPublicKey = null;
                connection = null;
                updateUI(false);
            }

            async function fetchBalance() {
                if (!connection || !userPublicKey) return;
                try {
                    const bal = await connection.getBalance(new solanaWeb3.PublicKey(userPublicKey));
                    walletBalanceElement.innerText = `${(bal / solanaWeb3.LAMPORTS_PER_SOL).toFixed(4)} SOL`;
                } catch (e) {
                    console.error("Bakiye HatasÄ±:", e);
                    walletBalanceElement.innerText = '-- SOL';
                }
            }

            // --- BUTON TIKLAMA Ä°ÅžLEMLERÄ° ---
            connectWalletBtn.onclick = () => {
                if (userPublicKey) {
                    disconnectWallet();
                } else {
                    const providers = getAvailableProviders();
                    if (providers.length === 0) {
                        statusMsg.innerText = getTranslation('statusNoWallet');
                        // EÄŸer hiÃ§biri yoksa yine de modal aÃ§alÄ±m, belki mobil tarayÄ±cÄ±dÄ±r
                        window.openModal('walletSelectModal');
                    } else if (providers.length === 1) {
                        // Sadece biri varsa direkt baÄŸlan
                        connectToProvider(providers[0].provider);
                    } else {
                        // Ä°kisi de varsa veya seÃ§im gerekiyorsa Modal AÃ§
                        window.openModal('walletSelectModal');
                    }
                }
            };

            spinBtn.onclick = async () => {
                if (!provider || !userPublicKey || isSpinning || isProcessing) return;
                
                isProcessing = true;
                spinBtn.disabled = true;
                spinBtn.innerText = getTranslation('spinBtnWaiting');
                
                // KullanÄ±cÄ±ya bilgi ver
                statusMsg.innerText = getTranslation('statusPaymentConfirm');
                statusMsg.className = "h-6 text-yellow-400 font-bold text-center mb-4"; // SarÄ± renk uyarÄ±

                try {
                    // BaÄŸlantÄ± kontrolÃ¼
                    if (!connection) connection = new solanaWeb3.Connection(RPC_URL, 'confirmed');

                    // 1. Transaction OluÅŸtur
                    const transaction = new solanaWeb3.Transaction().add(
                        solanaWeb3.SystemProgram.transfer({
                            fromPubkey: new solanaWeb3.PublicKey(userPublicKey),
                            toPubkey: new solanaWeb3.PublicKey(TREASURY_WALLET),
                            lamports: Math.floor(SOL_AMOUNT * solanaWeb3.LAMPORTS_PER_SOL)
                        })
                    );
                    
                    // 2. Blockhash Al (GÃ¼ncel aÄŸ durumu iÃ§in gerekli)
                    const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash();
                    transaction.recentBlockhash = blockhash;
                    transaction.feePayer = new solanaWeb3.PublicKey(userPublicKey);

                    // 3. CÃ¼zdandan Ä°MZA Ä°STE (Popup aÃ§ar)
                    // Backpack ve Phantom bu metodu destekler
                    const { signature } = await provider.signAndSendTransaction(transaction);
                    
                    statusMsg.innerText = getTranslation('statusPaymentSending');
                    statusMsg.className = "h-6 text-blue-400 font-bold text-center mb-4";

                    // 4. Onay Bekle
                    const confirmation = await connection.confirmTransaction({
                        signature,
                        blockhash,
                        lastValidBlockHeight
                    });

                    if (confirmation.value.err) throw new Error("Ä°ÅŸlem aÄŸda baÅŸarÄ±sÄ±z oldu.");

                    statusMsg.innerText = getTranslation('statusPaymentSuccess');
                    statusMsg.className = "h-6 text-green-400 font-bold text-center mb-4";
                    
                    // Bakiyeyi GÃ¼ncelle
                    fetchBalance();
                    
                    // OYUNU BAÅžLAT
                    await startSpinAnimation();

                } catch (error) {
                    console.error("Ã–deme HatasÄ±:", error);
                    let msg = error.message || "Bilinmeyen Hata";
                    
                    // Hata mesajlarÄ±nÄ± kullanÄ±cÄ± dostu hale getir
                    if (msg.includes("User rejected") || error.code === 4001) {
                        msg = getTranslation('statusPaymentRejected');
                    } else if (msg.includes("0x1")) {
                        msg = getTranslation('statusPaymentInsufficient'); 
                    } else if (msg.includes("403") || msg.includes("429")) {
                        msg = "AÄŸ yoÄŸun (RPC HatasÄ±). LÃ¼tfen tekrar deneyin.";
                    }

                    statusMsg.innerText = `${getTranslation('statusPaymentError')} ${msg}`;
                    statusMsg.className = "h-6 text-red-500 font-bold text-center mb-4";
                } finally {
                    isProcessing = false;
                    // EÄŸer Ã§ark dÃ¶nmÃ¼yorsa butonu tekrar aktif et
                    if (!isSpinning) {
                         spinBtn.disabled = false;
                         spinBtn.innerText = getTranslation('spinBtnActive');
                    }
                }
            };

            // --- OYUN MANTIÄžI (Ã‡ARK) ---
            const canvas = document.getElementById('wheelCanvas');
            const ctx = canvas.getContext('2d');
            // Ã–rnek basit havuz (0.5 SOL iÃ§in sayaÃ§)
            const prizePool = { SOL_05: { max: 5, current: 0 } }; 
            
            // Ã–dÃ¼l Listesi
            const prizes = [
                { text: "1 BTC", type: 'win', color: "#f7931a", txt: "#fff" }, 
                { text: "BOÅž", type: 'miss', color: "#334155", txt: "#94a3b8" }, 
                { text: "KÃœÃ‡ÃœK KAYIP", type: 'loss', color: "#64748b", txt: "#fff" }, 
                { text: "BOÅž", type: 'miss', color: "#1e293b", txt: "#64748b" }, 
                { text: "0.5 SOL", type: 'win', id: 'SOL_05', color: "#9945FF", txt: "#fff" },   
                { text: "BOÅž", type: 'miss', color: "#334155", txt: "#94a3b8" }, 
                { text: "KÃœÃ‡ÃœK KAYIP", type: 'loss', color: "#64748b", txt: "#fff" }, 
                { text: "50 XRP", type: 'win', color: "#2596be", txt: "#fff" }, 
                { text: "BOÅž", type: 'miss', color: "#1e293b", txt: "#64748b" }, 
                { text: "BÃœYÃœK KAYIP", type: 'huge_loss', color: "#881337", txt: "#fff" }, 
                { text: "0.01 ETH", type: 'win', color: "#627eea", txt: "#fff" },
                { text: "BOÅž", type: 'miss', color: "#334155", txt: "#94a3b8" }, 
                { text: "KÃœÃ‡ÃœK KAYIP", type: 'loss', color: "#64748b", txt: "#fff" }, 
                { text: "200 DOGE", type: 'win', color: "#C2A633", txt: "#fff" }, 
                { text: "BOÅž", type: 'miss', color: "#1e293b", txt: "#64748b" }, 
                { text: "50 USDT", type: 'win', color: "#26a17b", txt: "#fff" },
                { text: "BOÅž", type: 'miss', color: "#334155", txt: "#94a3b8" }, 
                { text: "KÃœÃ‡ÃœK KAYIP", type: 'loss', color: "#64748b", txt: "#fff" }, 
                { text: "BOÅž", type: 'miss', color: "#1e293b", txt: "#64748b" }, 
                { text: "0.1 SOL", type: 'win', id: 'SOL_SMALL', color: "#14F195", txt: "#000" }
            ];

            const totalPrizes = prizes.length;
            const sliceDeg = 360 / totalPrizes;
            let currentRotation = 0;

            function drawWheel() {
                const cx = canvas.width / 2;
                const cy = canvas.height / 2;
                const r = cx;
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                prizes.forEach((prize, i) => {
                    const angle = (i * 2 * Math.PI) / totalPrizes;
                    ctx.beginPath();
                    ctx.arc(cx, cy, r, angle, angle + (2 * Math.PI) / totalPrizes);
                    ctx.lineTo(cx, cy);
                    
                    const grad = ctx.createRadialGradient(cx, cy, r*0.1, cx, cy, r);
                    grad.addColorStop(0, prize.color);
                    grad.addColorStop(1, '#000');
                    ctx.fillStyle = grad;
                    ctx.fill();
                    ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();

                    ctx.save();
                    ctx.translate(cx, cy);
                    ctx.rotate(angle + (Math.PI / totalPrizes));
                    ctx.textAlign = "right";
                    ctx.fillStyle = prize.txt;
                    ctx.font = "bold 16px Montserrat";
                    ctx.fillText(prize.text, r - 25, 5);
                    ctx.restore();
                });
            }

            async function startSpinAnimation() {
                isSpinning = true;
                spinBtn.disabled = true;

                // Ses Efekti (Ä°steÄŸe baÄŸlÄ±)
                if (window.Tone) {
                    try {
                        if (Tone.context.state !== 'running') await Tone.start();
                        const synth = new Tone.NoiseSynth({ envelope: { release: 4 } }).toDestination();
                        synth.triggerAttackRelease("2n");
                    } catch(e) { console.log("Ses hatasÄ± (Ã¶nemsiz):", e); }
                }

                // --- KAZANMA MANTIÄžI ---
                // GerÃ§ek bir kumar uygulamasÄ± iÃ§in bu mantÄ±k sunucuda (backend) olmalÄ±dÄ±r.
                // Ä°stemci tarafÄ±nda yapÄ±lan iÅŸlemler manipÃ¼le edilebilir.
                const rnd = Math.random();
                let targetId = null;
                
                // %1 ihtimalle 0.5 SOL, %10 ihtimalle 0.1 SOL
                if (rnd < 0.01) targetId = 'SOL_05';
                else if (rnd < 0.10) targetId = 'SOL_SMALL';

                let targets = [];
                prizes.forEach((p, i) => {
                    if (targetId && p.id === targetId) {
                        if (targetId === 'SOL_05' && prizePool.SOL_05.current >= prizePool.SOL_05.max) return;
                        targets.push(i);
                    }
                    else if (!targetId && (p.type === 'miss' || p.type === 'loss' || p.type === 'huge_loss')) {
                        targets.push(i);
                    }
                });
                
                if (targets.length === 0) targets.push(1); // VarsayÄ±lan boÅŸ
                const winnerIndex = targets[Math.floor(Math.random() * targets.length)];
                
                // DÃ¶nÃ¼ÅŸ hesaplamasÄ±
                const targetAngle = (winnerIndex * sliceDeg) + (sliceDeg/2);
                let rot = targetAngle + 90; 
                rot += (Math.random() * (sliceDeg-10)) - (sliceDeg/2 - 5); 
                
                const spinAngle = (5 * 360) + (rot - (currentRotation % 360)); 
                if (spinAngle < 0) spinAngle += 360;

                currentRotation += spinAngle;
                canvas.style.transform = `rotate(-${currentRotation}deg)`;

                // DÃ¶nÃ¼ÅŸ bittiÄŸinde
                setTimeout(() => {
                    isSpinning = false;
                    spinBtn.disabled = false;
                    spinBtn.innerText = getTranslation('spinBtnActive');
                    
                    const winPrize = prizes[winnerIndex];
                    if (winPrize.id === 'SOL_05') prizePool.SOL_05.current++;

                    showResult(winPrize);
                }, 5000); // 5 saniye animasyon sÃ¼resi
            }

            function showResult(prize) {
                const title = document.getElementById('modalTitle');
                const msg = document.getElementById('modalMessage');
                const icon = document.getElementById('modalIcon');
                
                if (prize.type === 'win') {
                    title.innerText = getTranslation('modalTitle_win');
                    msg.innerText = prize.text + " KazandÄ±n!";
                    icon.innerText = "ðŸŽ‰";
                    
                    // Konfeti patlat
                    var d = 1500; var end = Date.now() + d;
                    (function frame() {
                        confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
                        confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
                        if (Date.now() < end) requestAnimationFrame(frame);
                    }());

                } else {
                    title.innerText = getTranslation('modalTitle_loss');
                    msg.innerText = prize.text;
                    icon.innerText = "ðŸ˜¢";
                }
                
                window.openModal('resultModal');
            }

            // Ä°lk Ã§izim
            drawWheel();

            // Modal YardÄ±mcÄ±larÄ±
            window.openModal = (id) => {
                const m = document.getElementById(id);
                m.classList.remove('hidden');
                setTimeout(() => {
                    m.classList.remove('opacity-0');
                    m.querySelector('div').classList.replace('scale-90','scale-100');
                },10);
            }
            window.closeModal = (id) => {
                const m = document.getElementById(id);
                m.classList.add('opacity-0');
                m.querySelector('div').classList.replace('scale-100','scale-90');
                setTimeout(() => m.classList.add('hidden'), 300);
            }
        });
    </script>
</body>
</html>
