<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="appTitle">Solana Premium Wheel</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Solana Web3.js -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <!-- Confetti Effect -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Tone.js (Sound Effects) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Rajdhani:wght@500;700&display=swap');
        
        :root {
            --gold-primary: #FFD700;
            --gold-secondary: #B8860B;
            --neon-purple: #bc13fe;
            --neon-blue: #00f3ff;
            --bg-deep: #050510;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg-deep);
            color: white;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            /* Modern Grid Background */
            background-image: 
                linear-gradient(rgba(188, 19, 254, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(188, 19, 254, 0.05) 1px, transparent 1px),
                radial-gradient(circle at 50% 0%, #1a1a40 0%, #050510 60%);
            background-size: 40px 40px, 40px 40px, 100% 100%;
        }

        /* Glassmorphism Ultra */
        .glass-panel {
            background: rgba(20, 20, 35, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* Titles */
        h1.brand-title {
            font-family: 'Cinzel', serif;
            background: linear-gradient(to right, #fff, #b4b4b4, #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
            letter-spacing: 2px;
        }

        /* Wheel Styles */
        .wheel-outer-ring {
            position: relative;
            padding: 12px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, var(--gold-secondary), var(--gold-primary), var(--gold-secondary), var(--gold-primary), var(--gold-secondary));
            box-shadow: 
                0 0 40px rgba(255, 215, 0, 0.2),
                inset 0 0 20px rgba(0, 0, 0, 0.8);
            /* Optional Rotation Animation for Ring */
            /* animation: ringRotate 20s linear infinite; */
        }

        .wheel-container {
            position: relative;
            width: 340px;
            height: 340px;
            border-radius: 50%;
            overflow: hidden;
            background: #0f0f1a;
            box-shadow: inset 0 0 30px rgba(0,0,0,1);
            z-index: 5;
            border: 4px solid #1a1a2e;
        }

        @media (min-width: 768px) {
            .wheel-container {
                width: 500px;
                height: 500px;
            }
        }

        /* Pointer */
        .stopper {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
        }
        .stopper svg {
            fill: url(#goldGradient);
        }
        
        /* Center Pivot */
        .center-pivot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #4a4a6a 0%, #1a1a2e 100%);
            border: 2px solid rgba(255, 215, 0, 0.5);
            box-shadow: 0 0 25px rgba(0,0,0,0.8);
            z-index: 25;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .center-logo {
            font-size: 32px;
            color: white;
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.5));
        }

        /* Buttons */
        .action-btn {
            position: relative;
            background: linear-gradient(135deg, var(--neon-purple), #7928ca);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(188, 19, 254, 0.4);
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }
        .action-btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        .action-btn:hover:not(:disabled)::before {
            left: 100%;
        }
        .action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(188, 19, 254, 0.6);
        }
        .action-btn:disabled {
            background: #2a2a35;
            color: #666;
            cursor: not-allowed;
            box-shadow: none;
            border-color: transparent;
        }

        /* Custom Animations */
        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.2); }
            50% { box-shadow: 0 0 40px rgba(255, 215, 0, 0.5); }
        }

        canvas {
            transition: transform 5s cubic-bezier(0.15, 0.85, 0.15, 1); 
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4">

    <!-- SVG Definitions -->
    <svg width="0" height="0">
        <defs>
            <linearGradient id="goldGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                <stop offset="50%" style="stop-color:#FFF8DC;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#B8860B;stop-opacity:1" />
            </linearGradient>
        </defs>
    </svg>

    <!-- Top Bar -->
    <div class="fixed top-0 left-0 w-full p-4 md:p-6 flex justify-between items-center z-50">
        <div class="glass-panel px-4 py-2 rounded-lg flex items-center gap-3">
            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-400 uppercase tracking-widest">Balance</span>
                <span class="text-lg font-bold font-mono text-green-300 leading-none" id="walletBalance">-- SOL</span>
            </div>
        </div>
        
        <button id="connectWalletBtn" class="glass-panel px-6 py-3 rounded-lg font-bold text-sm tracking-wide hover:bg-white/5 transition border-l-2 border-purple-500 flex items-center gap-2 group">
            <i class="fa-solid fa-wallet text-purple-400 group-hover:scale-110 transition"></i>
            <span id="walletAddress">Connect Wallet</span>
        </button>
    </div>

    <!-- Main Game Area -->
    <div class="relative z-10 w-full max-w-5xl flex flex-col items-center mt-20 md:mt-0">
        
        <!-- Header -->
        <div class="text-center mb-8 relative">
            <h1 class="brand-title text-4xl md:text-7xl font-black uppercase mb-3">
                Solana Spin
            </h1>
            <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full border border-yellow-500/30 bg-yellow-500/10 backdrop-blur-sm">
                <i class="fa-solid fa-coins text-yellow-400 text-xs"></i>
                <span class="text-xs md:text-sm font-semibold text-yellow-100 tracking-wider">Entry: 0.05 SOL</span>
            </div>
        </div>

        <!-- Wheel Component -->
        <div class="relative mb-12 transform scale-90 md:scale-100 transition-transform">
            <!-- Stopper (Arrow) -->
            <div class="stopper">
                <svg width="60" height="70" viewBox="0 0 60 70" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M30 70L0 20H60L30 70Z" />
                    <rect x="10" y="0" width="40" height="25" rx="4" />
                </svg>
            </div>
            
            <!-- Ring & Wheel -->
            <div class="wheel-outer-ring">
                <div class="wheel-container">
                    <canvas id="wheelCanvas" width="500" height="500"></canvas>
                </div>
            </div>

            <div class="center-pivot">
                <i class="fa-brands fa-solana center-logo"></i>
            </div>
        </div>

        <!-- Controls -->
        <div class="w-full max-w-md text-center space-y-6 relative">
            <!-- Status Text -->
            <div id="statusMessage" class="h-6 text-sm font-medium tracking-wider text-purple-300"></div>

            <!-- Main Button -->
            <button id="spinBtn" class="action-btn w-full py-5 rounded-xl text-xl md:text-2xl font-bold uppercase tracking-[0.2em] flex items-center justify-center gap-3" disabled>
                <i class="fa-solid fa-link" id="btnIcon"></i>
                <span id="btnText">Connect Wallet</span>
            </button>
            
            <!-- Footer Info -->
            <p class="text-xs text-gray-500 mt-4">
                Powered by Solana Blockchain â€¢ Provably Fair UI
            </p>
        </div>
    </div>

    <!-- Result Modal (Premium) -->
    <div id="resultModal" class="fixed inset-0 bg-black/90 backdrop-blur-lg flex items-center justify-center z-[100] hidden opacity-0 transition-opacity duration-500">
        <div class="glass-panel border border-purple-500/30 p-10 rounded-3xl text-center max-w-md w-full mx-6 shadow-2xl relative overflow-hidden transform scale-95 transition-transform duration-300" id="resultContent">
            <!-- Decorative Background -->
            <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-purple-900/20 to-transparent pointer-events-none"></div>
            
            <div id="modalIcon" class="text-7xl mb-6 filter drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]">ðŸŽ‰</div>
            <h2 id="modalTitle" class="text-4xl font-black text-white mb-3 font-[Cinzel] tracking-widest">WIN</h2>
            <div class="h-0.5 w-16 bg-gradient-to-r from-transparent via-yellow-500 to-transparent mx-auto my-6"></div>
            <p id="modalMessage" class="text-xl text-gray-200 mb-10 font-light">You won 0.5 SOL</p>
            
            <button onclick="closeModal('resultModal')" class="w-full bg-white text-black hover:bg-gray-200 font-bold py-4 rounded-xl transition uppercase tracking-widest text-sm">
                Play Again
            </button>
        </div>
    </div>
    
    <!-- Wallet Modal -->
    <div id="walletSelectModal" class="fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center z-[100] hidden opacity-0 transition-opacity duration-300">
        <div class="glass-panel border border-gray-700 p-8 rounded-2xl text-center max-w-sm w-full mx-4">
            <h2 class="text-2xl font-bold text-white mb-2 font-[Cinzel]">Connect</h2>
            <p class="text-gray-400 mb-8 text-xs uppercase tracking-wide">Select your provider</p>
            
            <div class="space-y-4">
                <button onclick="connectWalletType('backpack')" class="w-full bg-[#1a1a2e] hover:bg-[#252540] border border-gray-700 hover:border-blue-500 text-white py-4 px-6 rounded-xl transition flex items-center justify-between group">
                    <span class="flex items-center gap-4 font-bold">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c9/Backpack_Logo.png/640px-Backpack_Logo.png" class="w-8 h-8 rounded-lg" alt="Backpack">
                        Backpack
                    </span>
                    <div class="w-2 h-2 rounded-full bg-gray-600 group-hover:bg-blue-500 transition"></div>
                </button>
                
                <button onclick="connectWalletType('phantom')" class="w-full bg-[#1a1a2e] hover:bg-[#252540] border border-gray-700 hover:border-purple-500 text-white py-4 px-6 rounded-xl transition flex items-center justify-between group">
                    <span class="flex items-center gap-4 font-bold">
                        <img src="https://cryptologos.cc/logos/phantom-phantom-logo.png" class="w-8 h-8 rounded-lg" alt="Phantom">
                        Phantom
                    </span>
                    <div class="w-2 h-2 rounded-full bg-gray-600 group-hover:bg-purple-500 transition"></div>
                </button>
            </div>
            
            <button onclick="closeModal('walletSelectModal')" class="mt-8 text-gray-500 hover:text-white transition text-xs uppercase tracking-widest">Cancel</button>
        </div>
    </div>

    <script>
        // === GAME CONFIGURATION ===
        const CONFIG = {
            treasury: "DAwS12Yo6sF5isULcCQ24rhU67J7vHjRHsH5TjfYerFE",
            amount: 0.05,
            // Robust RPC list (Public nodes + Project Serum + Ankr)
            rpcEndpoints: [
                'https://rpc.ankr.com/solana',
                'https://solana-api.projectserum.com',
                'https://api.mainnet-beta.solana.com'
            ]
        };

        // === RESILIENT RPC MANAGER ===
        const RpcManager = {
            connection: null,

            // Lazy Load Connection (Don't fail on init)
            async getConnection(forceNew = false) {
                if (this.connection && !forceNew) return this.connection;
                
                // Try to find a working one from the list
                for (const url of CONFIG.rpcEndpoints) {
                    try {
                        const conn = new solanaWeb3.Connection(url, 'confirmed');
                        // Quick test
                        await conn.getSlot(); 
                        console.log(`Connected to RPC: ${url}`);
                        this.connection = conn;
                        return conn;
                    } catch (e) {
                        console.warn(`RPC ${url} unreachable.`);
                    }
                }
                
                // If all fail, return a default connection anyway so the app doesn't crash completely.
                // It will fail later during transaction, but UI will load.
                console.error("All RPCs failed, using fallback.");
                this.connection = new solanaWeb3.Connection(CONFIG.rpcEndpoints[0], 'confirmed');
                return this.connection;
            }
        };

        // === WALLET SERVICE ===
        const WalletService = {
            provider: null,
            publicKey: null,

            getProvider(type) {
                if (type === 'backpack') return window.backpack;
                if (type === 'phantom') {
                    if (window.phantom?.solana?.isPhantom) return window.phantom.solana;
                    return window.solana?.isPhantom ? window.solana : null;
                }
                return null;
            },
            
            async connect(type) {
                // Direct detection attempt
                const provider = this.getProvider(type);
                
                if (!provider) {
                    throw new Error(`${type} not detected. Please refresh or install extension.`);
                }

                try {
                    const response = await provider.connect();
                    this.provider = provider;
                    this.publicKey = (response.publicKey || provider.publicKey).toString();
                    
                    this.setupListeners();
                    return this.publicKey;
                } catch (err) {
                    console.error("Connect Error:", err);
                    throw err;
                }
            },

            async disconnect() {
                try { if (this.provider) await this.provider.disconnect(); } catch (e) {}
                this.provider = null;
                this.publicKey = null;
            },

            setupListeners() {
                if (!this.provider) return;
                this.provider.on('disconnect', () => {
                    this.disconnect().then(() => UI.update(false));
                });
                this.provider.on('accountChanged', (pk) => {
                    if (pk) { this.publicKey = pk.toString(); UI.update(true); } 
                    else { this.disconnect().then(() => UI.update(false)); }
                });
            },

            async getBalance() {
                if (!this.publicKey) return 0;
                try {
                    const conn = await RpcManager.getConnection();
                    const val = await conn.getBalance(new solanaWeb3.PublicKey(this.publicKey));
                    return val / solanaWeb3.LAMPORTS_PER_SOL;
                } catch (e) {
                    console.warn("Balance fetch failed", e);
                    return 0; // Return 0 instead of erroring out to keep UI alive
                }
            },

            async sendPayment() {
                if (!this.provider || !this.publicKey) throw new Error("Wallet disconnected");

                // Get a fresh connection to be safe
                const conn = await RpcManager.getConnection();

                const transaction = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({
                        fromPubkey: new solanaWeb3.PublicKey(this.publicKey),
                        toPubkey: new solanaWeb3.PublicKey(CONFIG.treasury),
                        lamports: Math.floor(CONFIG.amount * solanaWeb3.LAMPORTS_PER_SOL)
                    })
                );

                const { blockhash, lastValidBlockHeight } = await conn.getLatestBlockhash('finalized');
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = new solanaWeb3.PublicKey(this.publicKey);

                const { signature } = await this.provider.signAndSendTransaction(transaction);
                
                // Confirm
                const confirmation = await conn.confirmTransaction({
                    signature, blockhash, lastValidBlockHeight
                });

                if (confirmation.value.err) throw new Error("Transaction failed");
                return signature;
            }
        };

        // === UI CONTROLLER ===
        const UI = {
            els: {},
            init() {
                this.els = {
                    connectBtn: document.getElementById('connectWalletBtn'),
                    addressSpan: document.getElementById('walletAddress'),
                    statusMsg: document.getElementById('statusMessage'),
                    spinBtn: document.getElementById('spinBtn'),
                    btnText: document.getElementById('btnText'),
                    btnIcon: document.getElementById('btnIcon'),
                    balance: document.getElementById('walletBalance'),
                };
            },

            async update(isConnected) {
                if (isConnected && WalletService.publicKey) {
                    const key = WalletService.publicKey;
                    this.els.addressSpan.innerText = key.slice(0, 4) + '..' + key.slice(-4);
                    this.els.btnText.innerText = "SPIN NOW";
                    this.els.btnIcon.className = "fa-solid fa-play";
                    this.els.spinBtn.disabled = false;
                    this.setStatus("Wallet Connected", "success");
                    this.els.connectBtn.classList.add('border-green-400');
                    
                    const bal = await WalletService.getBalance();
                    this.els.balance.innerText = `${bal.toFixed(3)} SOL`;
                } else {
                    this.els.addressSpan.innerText = "Connect Wallet";
                    this.els.btnText.innerText = "Connect Wallet";
                    this.els.btnIcon.className = "fa-solid fa-link";
                    this.els.spinBtn.disabled = true;
                    this.els.balance.innerText = "-- SOL";
                    this.setStatus("", "");
                    this.els.connectBtn.classList.remove('border-green-400');
                }
            },

            setStatus(msg, type) {
                this.els.statusMsg.innerText = msg;
                if (type === 'success') this.els.statusMsg.className = "text-green-400 font-bold tracking-widest";
                else if (type === 'error') this.els.statusMsg.className = "text-red-400 font-bold tracking-widest";
                else this.els.statusMsg.className = "text-purple-300 tracking-widest animate-pulse";
            }
        };

        // === INITIALIZATION ===
        window.addEventListener('DOMContentLoaded', () => {
            UI.init();
            initWheel();
            
            // Pre-warm RPC (Optional, don't block UI)
            RpcManager.getConnection();

            document.getElementById('connectWalletBtn').onclick = () => {
                if (WalletService.publicKey) {
                    WalletService.disconnect().then(() => UI.update(false));
                } else {
                    window.openModal('walletSelectModal');
                }
            };

            window.connectWalletType = async (type) => {
                window.closeModal('walletSelectModal');
                try {
                    UI.setStatus("Connecting...", "warn");
                    await WalletService.connect(type);
                    UI.update(true);
                } catch (error) {
                    UI.setStatus(error.message || "Connection Failed", 'error');
                }
            };

            let isSpinning = false;
            document.getElementById('spinBtn').onclick = async () => {
                if (isSpinning) return;
                
                UI.els.spinBtn.disabled = true;
                UI.els.btnText.innerText = "Waiting...";
                UI.els.btnIcon.className = "fa-solid fa-circle-notch fa-spin";
                UI.setStatus("Please Approve in Wallet", "warn");

                try {
                    await WalletService.sendPayment();
                    
                    UI.setStatus("Payment Success! Spinning...", "success");
                    UI.update(true); 
                    
                    isSpinning = true;
                    await startSpinAnimation();

                } catch (error) {
                    console.error(error);
                    let msg = "Transaction Failed";
                    if (error.message.includes("rejected")) msg = "User Rejected";
                    
                    UI.setStatus(msg, "error");
                    
                    UI.els.spinBtn.disabled = false;
                    UI.els.btnText.innerText = "SPIN NOW";
                    UI.els.btnIcon.className = "fa-solid fa-play";
                    isSpinning = false;
                }
            };
        });

        // === WHEEL LOGIC (Enhanced Visuals) ===
        function initWheel() {
            const canvas = document.getElementById('wheelCanvas');
            const ctx = canvas.getContext('2d');
            
            const prizes = [
                { text: "1 BTC", type: 'win', bg: "#FFD700", txt: "#000" }, 
                { text: "EMPTY", type: 'miss', bg: "#1F2937", txt: "#6B7280" }, 
                { text: "LOSS", type: 'loss', bg: "#374151", txt: "#9CA3AF" }, 
                { text: "EMPTY", type: 'miss', bg: "#1F2937", txt: "#6B7280" }, 
                { text: "0.5 SOL", type: 'win', id: 'SOL_05', bg: "#bc13fe", txt: "#fff" },   
                { text: "EMPTY", type: 'miss', bg: "#1F2937", txt: "#6B7280" }, 
                { text: "LOSS", type: 'loss', bg: "#374151", txt: "#9CA3AF" }, 
                { text: "50 XRP", type: 'win', bg: "#3b82f6", txt: "#fff" }, 
                { text: "EMPTY", type: 'miss', bg: "#1F2937", txt: "#6B7280" }, 
                { text: "REKT", type: 'huge_loss', bg: "#ef4444", txt: "#fff" }, 
                { text: "0.01 ETH", type: 'win', bg: "#6366f1", txt: "#fff" },
                { text: "EMPTY", type: 'miss', bg: "#1F2937", txt: "#6B7280" }, 
                { text: "LOSS", type: 'loss', bg: "#374151", txt: "#9CA3AF" }, 
                { text: "DOGE", type: 'win', bg: "#F59E0B", txt: "#000" }, 
                { text: "EMPTY", type: 'miss', bg: "#1F2937", txt: "#6B7280" }, 
                { text: "50 USDT", type: 'win', bg: "#10B981", txt: "#000" },
                { text: "EMPTY", type: 'miss', bg: "#1F2937", txt: "#6B7280" }, 
                { text: "LOSS", type: 'loss', bg: "#374151", txt: "#9CA3AF" }, 
                { text: "EMPTY", type: 'miss', bg: "#1F2937", txt: "#6B7280" }, 
                { text: "0.1 SOL", type: 'win', id: 'SOL_SMALL', bg: "#14F195", txt: "#000" }
            ];

            const totalPrizes = prizes.length;
            let currentRotation = 0;

            function drawWheel() {
                const cx = canvas.width / 2;
                const cy = canvas.height / 2;
                const r = cx - 4; // slight padding
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                prizes.forEach((prize, i) => {
                    const angle = (i * 2 * Math.PI) / totalPrizes;
                    const endAngle = angle + (2 * Math.PI) / totalPrizes;
                    
                    ctx.beginPath();
                    ctx.moveTo(cx, cy);
                    ctx.arc(cx, cy, r, angle, endAngle);
                    ctx.lineTo(cx, cy);
                    ctx.fillStyle = prize.bg;
                    ctx.fill();
                    
                    ctx.strokeStyle = '#0f0f1a';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // Text
                    ctx.save();
                    ctx.translate(cx, cy);
                    ctx.rotate(angle + (Math.PI / totalPrizes));
                    ctx.textAlign = "right";
                    ctx.fillStyle = prize.txt;
                    ctx.font = "bold 15px Rajdhani";
                    ctx.fillText(prize.text, r - 30, 5);
                    ctx.restore();
                });
            }

            window.startSpinAnimation = async () => {
                if (window.Tone) {
                    try { await Tone.start(); new Tone.MembraneSynth().toDestination().triggerAttackRelease("C2", "8n"); } catch(e){}
                }

                const rnd = Math.random();
                let targetId = null;
                // Demo Odds: 1% for 0.5 SOL, 10% for 0.1 SOL
                if (rnd < 0.01) targetId = 'SOL_05';
                else if (rnd < 0.10) targetId = 'SOL_SMALL';

                let targets = [];
                prizes.forEach((p, i) => {
                    if (targetId && p.id === targetId) targets.push(i);
                    else if (!targetId && (p.type === 'miss' || p.type === 'loss' || p.type === 'huge_loss')) targets.push(i);
                });
                
                if (targets.length === 0) targets.push(1);
                const winnerIndex = targets[Math.floor(Math.random() * targets.length)];
                
                const sliceDeg = 360 / totalPrizes;
                const targetAngle = (winnerIndex * sliceDeg) + (sliceDeg/2);
                let rot = targetAngle + 90; 
                rot += (Math.random() * (sliceDeg-12)) - (sliceDeg/2 - 6); 
                
                const spinAngle = (8 * 360) + (rot - (currentRotation % 360)); 
                currentRotation += spinAngle;
                
                canvas.style.transform = `rotate(-${currentRotation}deg)`;

                return new Promise(resolve => {
                    setTimeout(() => {
                        showResult(prizes[winnerIndex]);
                        resolve();
                    }, 5000);
                });
            };

            function showResult(prize) {
                const title = document.getElementById('modalTitle');
                const msg = document.getElementById('modalMessage');
                const icon = document.getElementById('modalIcon');
                
                if (prize.type === 'win') {
                    title.innerText = "BIG WIN!";
                    title.className = "text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-yellow-200 mb-2 font-[Cinzel]";
                    msg.innerText = `You won ${prize.text}`;
                    icon.innerText = "ðŸ’°";
                    
                    const duration = 2000;
                    const end = Date.now() + duration;
                    (function frame() {
                        confetti({ particleCount: 4, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#FFD700', '#bc13fe'] });
                        confetti({ particleCount: 4, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#FFD700', '#bc13fe'] });
                        if (Date.now() < end) requestAnimationFrame(frame);
                    }());
                    
                    if (window.Tone) new Tone.PolySynth(Tone.Synth).toDestination().triggerAttackRelease(["C4", "E4", "G4", "C5"], "8n");
                } else {
                    title.innerText = "NO LUCK";
                    title.className = "text-4xl font-black text-gray-500 mb-2 font-[Cinzel]";
                    msg.innerText = "Better luck next time";
                    icon.innerText = "ðŸ’¸";
                }
                
                const modal = document.getElementById('resultModal');
                const content = document.getElementById('resultContent');
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.replace('scale-95','scale-100');
                }, 10);
            }

            drawWheel();
        }

        // === GLOBAL MODALS ===
        window.openModal = (id) => {
            const m = document.getElementById(id);
            m.classList.remove('hidden');
            setTimeout(() => m.classList.remove('opacity-0'), 10);
        }
        window.closeModal = (id) => {
            const m = document.getElementById(id);
            const content = m.querySelector('.glass-panel'); // Target content for animation
            m.classList.add('opacity-0');
            if(content) content.classList.replace('scale-100','scale-95');
            setTimeout(() => m.classList.add('hidden'), 300);
        }
    </script>
</body>
</html>
