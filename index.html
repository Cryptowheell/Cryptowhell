<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Spin - Pro</title>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                solanaPurple: '#9945FF',
                solanaGreen: '#14F195',
              },
              animation: {
                'spin-slow': 'spin 10s linear infinite',
                'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              },
              boxShadow: {
                'neon-purple': '0 0 20px theme("colors.solanaPurple"), 0 0 40px theme("colors.solanaPurple")',
                'neon-green': '0 0 20px theme("colors.solanaGreen"), 0 0 40px theme("colors.solanaGreen")',
              }
            }
          }
        }
      </script>
    
    <!-- Solana Web3.js -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

    <style>
        body {
            background: radial-gradient(circle at center, #1e1e3f 0%, #0f172a 100%);
            color: white;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        body::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(153, 69, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(153, 69, 255, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: -1;
        }

        /* Wheel Rotation Animation */
        .wheel-rotate {
            transition: transform 6s cubic-bezier(0.1, 0.8, 0.1, 1);
        }

        /* Separators */
        .wheel-separator {
            position: absolute;
            top: 0; left: 50%;
            width: 2px;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.8), transparent);
            transform-origin: bottom center;
            z-index: 5;
            box-shadow: 0 0 4px rgba(0,0,0,0.5);
        }

        /* Outer Glow Ring */
        .wheel-outer-ring {
            position: absolute;
            top: -15px; left: -15px; right: -15px; bottom: -15px;
            border-radius: 50%;
            border: 4px solid rgba(153, 69, 255, 0.5);
            box-shadow: 0 0 30px rgba(153, 69, 255, 0.3), inset 0 0 30px rgba(153, 69, 255, 0.3);
            z-index: -1;
            animation: pulse-ring 3s infinite alternate;
        }
        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.02); opacity: 1; box-shadow: 0 0 50px rgba(20, 241, 149, 0.5), inset 0 0 50px rgba(20, 241, 149, 0.5); border-color: rgba(20, 241, 149, 0.5); }
        }

        .segment-text {
            text-shadow: 1px 1px 2px rgba(0,0,0,0.9);
        }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { Connection, PublicKey, Transaction, SystemProgram, clusterApiUrl, LAMPORTS_PER_SOL } = solanaWeb3;

        // --- CONFIGURATION ---
        const SOLANA_NETWORK = 'mainnet-beta'; 
        const SPIN_COST = 0.01; // Updated to 0.01 SOL
        const HOUSE_ADDRESS = "CTD6awXNUksKhCFcZX8Ubst2ANxioUUNX1iRbhTYKxby";

        // Segments with Weights (Probability)
        // Higher weight = Higher chance to land
        // Total Weight = 100 (for easier calculation)
        // Losing segments are increased visually and mathematically.
        const SEGMENTS = [
            { label: "2 SOL",   value: 2,    color: "#FFD700", textColor: "#000", type: "win", weight: 1 },  // 1% Chance (Jackpot)
            { label: "LOST",    value: 0,    color: "#D32F2F", textColor: "#FFF", type: "lose", weight: 30 }, // 30% Chance
            { label: "0.1 SOL", value: 0.1,  color: "#9945FF", textColor: "#FFF", type: "win", weight: 10 }, // 10% Chance
            { label: "EMPTY",   value: 0,    color: "#EF5350", textColor: "#FFF", type: "lose", weight: 20 }, // 20% Chance
            { label: "1 SOL",   value: 1,    color: "#FFA000", textColor: "#000", type: "win", weight: 2 },  // 2% Chance
            { label: "TRY AGAIN", value: 0,  color: "#C62828", textColor: "#FFF", type: "lose", weight: 20 }, // 20% Chance
            { label: "0.05 SOL", value: 0.05, color: "#14F195", textColor: "#000", type: "win", weight: 12 }, // 12% Chance
            { label: "BAD LUCK", value: 0,   color: "#B71C1C", textColor: "#FFF", type: "lose", weight: 5 },  // 5% Chance
        ];

        function App() {
            const [walletAddress, setWalletAddress] = React.useState(null);
            const [balance, setBalance] = React.useState(0);
            const [isSpinning, setIsSpinning] = React.useState(false);
            const [rotation, setRotation] = React.useState(0);
            const [status, setStatus] = React.useState({ type: 'info', msg: 'Connect wallet to start playing.' });
            
            const connection = new Connection(clusterApiUrl(SOLANA_NETWORK), 'confirmed');

            const connectWallet = async () => {
                try {
                    const { solana } = window;
                    if (!solana) {
                        if(window.phantom?.solana) {
                             await window.phantom.solana.connect();
                             handleConnection(window.phantom.solana);
                             return;
                        }
                        alert("Phantom Wallet not found!");
                        window.open("https://phantom.app/", "_blank");
                        return;
                    }
                    if (solana.isPhantom) {
                        const response = await solana.connect();
                        handleConnection(solana);
                    }
                } catch (err) {
                    console.error("Connection Error:", err);
                    setStatus({ type: 'error', msg: 'Connection rejected.' });
                }
            };

            const handleConnection = (provider) => {
                const pubKey = provider.publicKey.toString();
                setWalletAddress(pubKey);
                getBalance(provider.publicKey);
                setStatus({ type: 'success', msg: 'Wallet connected! Good luck.' });
            }

            const getBalance = async (publicKey) => {
                try {
                    const bal = await connection.getBalance(publicKey);
                    setBalance(bal / LAMPORTS_PER_SOL);
                } catch (err) {
                    console.error("Balance Error", err);
                }
            };

            const handleSpin = async () => {
                if (!walletAddress || isSpinning) return;
                
                const { solana } = window;
                const provider = solana || window.phantom?.solana;
                if (!provider) return;

                setStatus({ type: 'process', msg: 'Preparing transaction...' });

                try {
                    const sender = new PublicKey(walletAddress);
                    const receiver = new PublicKey(HOUSE_ADDRESS); 

                    const transaction = new Transaction().add(
                        SystemProgram.transfer({
                            fromPubkey: sender,
                            toPubkey: receiver, 
                            lamports: SPIN_COST * LAMPORTS_PER_SOL,
                        })
                    );

                    const { blockhash } = await connection.getLatestBlockhash();
                    transaction.recentBlockhash = blockhash;
                    transaction.feePayer = sender;

                    setStatus({ type: 'process', msg: `Please approve ${SPIN_COST} SOL...` });

                    const signedTransaction = await provider.signTransaction(transaction);
                    const signature = await connection.sendRawTransaction(signedTransaction.serialize());
                    
                    setStatus({ type: 'process', msg: 'Confirming transaction...' });
                    await connection.confirmTransaction(signature, 'processed');

                    setStatus({ type: 'success', msg: 'Spinning... ðŸŽ¡' });
                    getBalance(sender);
                    
                    // Start the Weighted Spin
                    startWeightedSpin();

                } catch (error) {
                    console.error("Transaction Error:", error);
                    setStatus({ type: 'error', msg: 'Transaction failed.' });
                }
            };

            const startWeightedSpin = () => {
                setIsSpinning(true);
                
                // --- PROBABILITY LOGIC ---
                // 1. Calculate Total Weight
                const totalWeight = SEGMENTS.reduce((sum, seg) => sum + seg.weight, 0);
                
                // 2. Pick a random number between 0 and TotalWeight
                let randomNum = Math.random() * totalWeight;
                
                // 3. Find which segment corresponds to this number
                let selectedIndex = 0;
                for (let i = 0; i < SEGMENTS.length; i++) {
                    if (randomNum < SEGMENTS[i].weight) {
                        selectedIndex = i;
                        break;
                    }
                    randomNum -= SEGMENTS[i].weight;
                }

                // 4. Calculate Rotation to land on Selected Segment
                // Each segment is 45 degrees.
                // To land on Index I, we need the wheel to stop such that Index I is at the top (270deg or 0deg depending on CSS).
                // Logic: 
                // Full Circle = 360.
                // Segment Angle = 45.
                // Target Angle Base = selectedIndex * 45.
                // We add some random "fuzziness" (10 to 35 deg) inside the segment so it doesn't land on the line.
                const segmentFuzziness = 10 + Math.random() * 25; 
                
                // The calculation to land on a specific index in a conic gradient:
                // We need to rotate BACKWARDS relative to the index position.
                // Target Rotation = (Full Spins) - (Index * 45) - Fuzziness
                const extraSpins = 360 * 5; // 5 Full spins minimum
                const targetRotation = extraSpins + (360 - (selectedIndex * 45)) - segmentFuzziness;

                // Add to existing rotation so it spins forward continuously
                // We modulus current rotation to keep numbers sane, then add target
                const newRotation = rotation + targetRotation;

                setRotation(newRotation);

                // 6 seconds delay (matches CSS)
                setTimeout(() => {
                    setIsSpinning(false);
                    calculateResult(selectedIndex);
                }, 6000);
            };

            const calculateResult = (index) => {
                const result = SEGMENTS[index];

                if (result.type === 'win') {
                    setStatus({ type: 'win', msg: `ðŸŽ‰ WON ${result.label}! Check wallet for rewards!` });
                } else {
                    setStatus({ type: 'lose', msg: `Result: ${result.label}. Better luck next time!` });
                }
            };

            const WalletIcon = () => (
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
            );

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 relative overflow-hidden">
                    
                    {/* Background Effects */}
                    <div className="absolute top-0 left-0 w-full h-full bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-solanaPurple/20 via-transparent to-transparent opacity-50 pointer-events-none"></div>
                    <div className="absolute bottom-0 right-0 w-full h-full bg-[radial-gradient(ellipse_at_bottom,_var(--tw-gradient-stops))] from-solanaGreen/20 via-transparent to-transparent opacity-50 pointer-events-none"></div>

                    {/* Header */}
                    <div className="w-full max-w-lg flex justify-between items-center mb-10 p-5 bg-slate-800/80 backdrop-blur-md rounded-2xl border border-slate-700/50 shadow-xl z-10">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-gradient-to-tr from-solanaPurple to-solanaGreen rounded-full flex items-center justify-center shadow-lg animate-spin-slow">
                                <span className="text-2xl">â—Ž</span>
                            </div>
                            <h1 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-solanaPurple via-white to-solanaGreen">
                                SOLANA SPIN
                            </h1>
                        </div>
                        
                        {!walletAddress ? (
                            <button onClick={connectWallet} className="flex items-center gap-2 bg-gradient-to-r from-solanaPurple to-indigo-600 hover:scale-105 px-5 py-2.5 rounded-xl font-bold transition-all shadow-lg text-white">
                                <WalletIcon /> Connect
                            </button>
                        ) : (
                            <div className="text-right bg-slate-900/50 px-4 py-2 rounded-lg border border-slate-700">
                                <div className="text-xs text-slate-400 font-medium uppercase">Balance</div>
                                <div className="font-mono text-lg text-solanaGreen font-bold">{balance.toFixed(3)} SOL</div>
                            </div>
                        )}
                    </div>

                    {/* WHEEL AREA */}
                    <div className="relative mb-12 z-10 group">
                        {/* Pointer */}
                        <div className="absolute -top-10 left-1/2 transform -translate-x-1/2 z-30 filter drop-shadow-lg">
                            <div className="w-12 h-16 bg-gradient-to-b from-yellow-300 to-yellow-600 clip-path-polygon-[50%_100%,_0_0,_100%_0] relative"></div>
                        </div>

                        {/* Outer Ring */}
                        <div className="wheel-outer-ring"></div>

                        {/* Wheel */}
                        <div className="w-[22rem] h-[22rem] sm:w-[26rem] sm:h-[26rem] md:w-[30rem] md:h-[30rem] rounded-full border-[8px] border-slate-200/80 overflow-hidden shadow-2xl bg-slate-900 relative ring-4 ring-solanaPurple/50">
                            
                            <div 
                                className="w-full h-full rounded-full wheel-rotate relative"
                                style={{ 
                                    transform: `rotate(${rotation}deg)`,
                                    background: `conic-gradient(
                                        ${SEGMENTS[0].color} 0deg 45deg,
                                        ${SEGMENTS[1].color} 45deg 90deg,
                                        ${SEGMENTS[2].color} 90deg 135deg,
                                        ${SEGMENTS[3].color} 135deg 180deg,
                                        ${SEGMENTS[4].color} 180deg 225deg,
                                        ${SEGMENTS[5].color} 225deg 270deg,
                                        ${SEGMENTS[6].color} 270deg 315deg,
                                        ${SEGMENTS[7].color} 315deg 360deg
                                    )`
                                }}
                            >
                                {/* Separators */}
                                {[...Array(8)].map((_, i) => (
                                    <div key={`sep-${i}`} className="wheel-separator" style={{ transform: `rotate(${i * 45}deg)` }}></div>
                                ))}

                                {/* Labels (Fixed Alignment) */}
                                {SEGMENTS.map((seg, i) => (
                                    <div 
                                        key={i}
                                        className="absolute w-full h-full top-0 left-0 flex justify-center pt-8"
                                        style={{ transform: `rotate(${i * 45 + 22.5}deg)` }}
                                    >
                                        <div className="text-center w-20">
                                            <span 
                                                className="block font-black segment-text whitespace-nowrap" 
                                                style={{ 
                                                    color: seg.textColor,
                                                    fontSize: seg.label.length > 5 ? '14px' : '20px', // Adjust font size based on text length
                                                    transform: 'scale(1.1)' 
                                                }}
                                            >
                                                {seg.label}
                                            </span>
                                            {seg.type === 'win' && (
                                                <span className="text-[10px] font-bold opacity-90 block mt-1" style={{ color: seg.textColor }}>WIN</span>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                            
                            {/* Center Hub */}
                            <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-20 h-20 bg-white rounded-full flex items-center justify-center border-[6px] border-slate-100 shadow-inner z-20">
                                <span className="text-3xl">ðŸŽ°</span>
                            </div>
                        </div>
                    </div>

                    {/* Status Panel */}
                    <div className={`mb-8 px-6 py-4 rounded-2xl border-2 text-center font-bold text-lg w-full max-w-md transition-all duration-500 backdrop-blur-sm shadow-lg z-10 ${
                        status.type === 'error' ? 'bg-red-950/60 border-red-500/50 text-red-200' :
                        status.type === 'win' ? 'bg-green-950/60 border-green-500/50 text-green-200 scale-105' :
                        status.type === 'process' ? 'bg-blue-950/60 border-blue-500/50 text-blue-200 animate-pulse' :
                        'bg-slate-800/60 border-slate-700/50 text-slate-300'
                    }`}>
                        {status.msg}
                    </div>

                    {/* SPIN BUTTON */}
                    <button 
                        onClick={handleSpin}
                        disabled={!walletAddress || isSpinning}
                        className={`
                            relative z-10 group w-full max-w-sm px-8 py-5 rounded-full font-black text-2xl transition-all duration-300 transform shadow-2xl
                            ${!walletAddress 
                                ? 'bg-slate-700/50 text-slate-500 cursor-not-allowed border-2 border-slate-600' 
                                : isSpinning 
                                    ? 'bg-slate-600/50 text-slate-400 cursor-wait border-2 border-slate-500'
                                    : 'bg-gradient-to-r from-solanaPurple via-purple-600 to-solanaGreen hover:scale-105 text-white border-2 border-transparent hover:border-white/20'
                            }
                        `}
                    >
                        {isSpinning ? 'SPINNING...' : `SPIN (${SPIN_COST} SOL)`}
                    </button>
                    
                    <p className="mt-8 text-xs font-medium text-slate-500 text-center relative z-10 uppercase tracking-widest">
                        SOLANA MAINNET ACTIVE
                    </p>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
